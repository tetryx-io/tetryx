steps:
  - id: 'docker-login-aws'
    name: '${_GCP_BUILDER_URL}'
    entrypoint: bash
    args:
      - '-c'
      - |
        aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 513054450991.dkr.ecr.us-east-2.amazonaws.com
    env: [ 'AWS_ACCESS_KEY_ID=${_AWS_ACCESS_KEY_ID}', 'AWS_SECRET_ACCESS_KEY=${_AWS_SECRET_ACCESS_KEY}' ]
  - id: 'docker-build'
    name: '${_GCP_BUILDER_URL}'
    entrypoint: 'docker'
    args: [ 'build',
            '-t', '${_GCP_IMAGE_URL}:latest',
            '-t', '${_GCP_IMAGE_URL}:${BUILD_ID}',
            '-t', '${_GCP_IMAGE_URL}:${COMMIT_SHA}',
            '--build-arg', 'GIT_PAT=${_GIT_PAT}',
            '--build-arg', 'GIT_USER=${_GIT_USER}',
            '--build-arg', 'BRANCH_NAME=${BRANCH_NAME}',
            '--build-arg', 'BASE_IMAGE=${_BASE_IMAGE}',
            '--build-arg', 'NEXT_PUBLIC_API_BASE_URL=${_NEXT_PUBLIC_API_BASE_URL}',
            '--build-arg', 'NEXT_PUBLIC_GOOGLE_ANALYTICS=${_NEXT_PUBLIC_GOOGLE_ANALYTICS}',
            '--build-arg', 'NEXT_PUBLIC_GA_MEASUREMENT_ID=${_NEXT_PUBLIC_GA_MEASUREMENT_ID}',
            '--build-arg', 'NEXT_PUBLIC_POSTHOG_KEY=${_NEXT_PUBLIC_POSTHOG_KEY}',
            '--build-arg', 'NEXT_PUBLIC_POSTHOG_HOST=${_NEXT_PUBLIC_POSTHOG_HOST}',
            '-f', 'Dockerfile',
            '.']
    waitFor: ['-']
  - id: 'artifact-registry-push'
    name: '${_GCP_BUILDER_URL}'
    entrypoint: 'docker'
    args: [ 'push', '${_GCP_IMAGE_URL}:${COMMIT_SHA}']
    waitFor: ['docker-build']
  - id: 'cloudrun-deploy'
    name: '${_GCP_BUILDER_URL}'
    entrypoint: 'gcloud'
    args: [ 'run', 'deploy', '${_GCP_CLOUD_RUN_SERVICE_NAME}',
            '--image=${_GCP_IMAGE_URL}:${COMMIT_SHA}',
            '--region=us-central1'
          ]
    waitFor: ['artifact-registry-push']
images:
  - '${_GCP_IMAGE_URL}:latest'
  - '${_GCP_IMAGE_URL}:${BUILD_ID}'
  - '${_GCP_IMAGE_URL}:${COMMIT_SHA}'
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
